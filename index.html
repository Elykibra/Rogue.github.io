<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dungeon Party</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #1a1a1a;
            color: #e5e5e5;
            touch-action: none; /* Prevent scroll on mobile tap */
        }

        .pixel-border {
            box-shadow: 
                -4px 0 0 0 #e5e5e5,
                4px 0 0 0 #e5e5e5,
                0 -4px 0 0 #e5e5e5,
                0 4px 0 0 #e5e5e5;
            margin: 4px;
        }

        .btn-pixel {
            position: relative;
            display: inline-block;
            padding: 15px 30px;
            background: #4a4a4a;
            color: white;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            box-shadow: inset -4px -4px 0px 0px rgba(0,0,0,0.5), inset 4px 4px 0px 0px rgba(255,255,255,0.2);
            transition: all 0.1s;
        }
        
        .btn-pixel:active {
            transform: translateY(2px);
            box-shadow: inset -2px -2px 0px 0px rgba(0,0,0,0.5), inset 2px 2px 0px 0px rgba(255,255,255,0.2);
        }

        .btn-pixel.primary { background: #3b82f6; }
        .btn-pixel.secondary { background: #10b981; }
        .btn-pixel.danger { background: #ef4444; }

        .char-card {
            border: 4px solid #333;
            cursor: pointer;
            transition: all 0.2s;
        }
        .char-card:hover { transform: scale(1.05); }
        .char-card.selected {
            border-color: #fbbf24; /* Amber-400 */
            background: #333;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
        }

        canvas {
            image-rendering: pixelated; /* Sharp pixels */
            width: 100%;
            height: 100%;
        }

        #dpad button {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.1);
            border: 2px solid #555;
            border-radius: 8px;
            color: white;
            font-size: 20px;
        }
        #dpad button:active { background: rgba(255,255,255,0.3); }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col items-center justify-center p-4">

    <div id="app" class="relative z-20 w-full max-w-2xl h-full flex flex-col justify-center">
        
        <!-- HEADER -->
        <div id="header" class="text-center mb-4 shrink-0">
            <h1 class="text-xl md:text-2xl text-yellow-400 mb-2 text-shadow">DUNGEON SYNC</h1>
        </div>

        <!-- ERROR MESSAGE -->
        <div id="error-display" class="hidden mb-4 p-2 bg-red-900/90 border-2 border-red-500 text-red-200 text-xs text-center fixed top-4 left-4 right-4 z-50"></div>

        <!-- VIEW: LOADING -->
        <div id="view-loading" class="text-center">
            <p class="animate-pulse text-blue-300">Connecting to Nethernet...</p>
        </div>

        <!-- VIEW: MAIN MENU -->
        <div id="view-menu" class="hidden flex flex-col gap-6 items-center">
            <div class="pixel-border p-8 bg-gray-800 text-center w-full max-w-md">
                <p id="user-display" class="text-xs text-blue-300 mb-8 truncate"></p>
                <div class="flex flex-col gap-4">
                    <button id="btn-create-menu" class="btn-pixel primary">Create Party</button>
                    <button id="btn-join-menu" class="btn-pixel secondary">Join Party</button>
                </div>
            </div>
        </div>

        <!-- VIEW: CHARACTER SELECT -->
        <div id="view-character-select" class="hidden w-full flex justify-center">
            <div class="pixel-border p-6 bg-gray-800 w-full max-w-md">
                <h2 class="text-center mb-6 text-yellow-400 text-sm">CHOOSE YOUR HERO</h2>
                
                <div id="char-grid" class="grid grid-cols-2 gap-4 mb-6">
                    <!-- Injected by JS -->
                </div>

                <div class="text-center mb-6 h-12">
                    <p id="char-desc-name" class="text-yellow-400 text-xs mb-1">Select a Class</p>
                    <p id="char-desc-stats" class="text-gray-400 text-[10px]">...</p>
                </div>

                <div class="flex gap-4">
                    <button id="btn-back-char" class="btn-pixel w-1/2 text-xs">Back</button>
                    <button id="btn-confirm-char" class="btn-pixel secondary w-1/2 text-xs">Confirm</button>
                </div>
            </div>
        </div>

        <!-- VIEW: JOIN INPUT -->
        <div id="view-join-input" class="hidden w-full flex justify-center">
            <div class="pixel-border p-6 bg-gray-800 w-full max-w-md">
                <h2 class="text-center mb-6 text-yellow-400">Enter Room Code</h2>
                <input type="text" id="input-room-code" maxlength="4" placeholder="ABCD" 
                    class="w-full bg-gray-900 border-2 border-gray-600 p-4 text-center text-xl tracking-[0.5em] text-white uppercase mb-6 focus:outline-none focus:border-blue-500">
                <div class="flex gap-4">
                    <button id="btn-back-join" class="btn-pixel w-1/2">Back</button>
                    <button id="btn-confirm-join" class="btn-pixel secondary w-1/2">Connect</button>
                </div>
            </div>
        </div>

        <!-- VIEW: LOBBY -->
        <div id="view-lobby" class="hidden w-full flex justify-center">
            <div class="pixel-border p-6 bg-gray-800 w-full max-w-md">
                <div class="flex justify-between items-center mb-6 border-b-2 border-gray-600 pb-4">
                    <div>
                        <span class="text-xs text-gray-400 block mb-1">ROOM CODE</span>
                        <span id="display-room-code" class="text-2xl text-yellow-400 tracking-widest cursor-pointer">????</span>
                    </div>
                    <div id="lobby-status" class="text-xs bg-green-900 text-green-300 px-2 py-1">WAITING</div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xs text-blue-300 mb-4">PARTY MEMBERS</h3>
                    <div id="player-list" class="space-y-3"></div>
                </div>

                <div id="host-controls" class="hidden border-t-2 border-gray-600 pt-4 mt-4">
                    <button id="btn-start-game" class="btn-pixel secondary w-full mb-2">Enter Dungeon</button>
                </div>

                <div id="guest-controls" class="hidden border-t-2 border-gray-600 pt-4 mt-4">
                    <p class="text-xs text-center animate-pulse">Waiting for host...</p>
                </div>
                <button id="btn-leave-lobby" class="btn-pixel danger w-full mt-4 text-xs">Leave</button>
            </div>
        </div>

        <!-- VIEW: GAME -->
        <div id="view-game" class="hidden flex-col h-full items-center">
            <div class="relative w-full max-w-md aspect-square bg-black pixel-border mb-2 overflow-hidden">
                <canvas id="game-canvas" width="400" height="400"></canvas>
                <!-- Loading overlay for guests waiting for map -->
                <div id="game-loading" class="absolute inset-0 bg-black/80 flex items-center justify-center hidden">
                    <span class="text-yellow-400 animate-pulse">Syncing Map...</span>
                </div>
            </div>
            
            <div class="flex justify-between w-full max-w-md px-2 items-center">
                <p class="text-[10px] text-gray-400">Arrows/WASD to move</p>
                <button id="btn-exit-game" class="text-[10px] text-red-400 hover:text-red-200 uppercase">Exit Run</button>
            </div>

            <!-- Mobile Controls -->
            <div id="dpad" class="mt-4 grid grid-cols-3 gap-2 md:hidden">
                <div></div>
                <button id="btn-up">▲</button>
                <div></div>
                <button id="btn-left">◀</button>
                <button id="btn-down">▼</button>
                <button id="btn-right">▶</button>
            </div>
        </div>

    </div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- STATE ---
        let currentUser = null;
        let currentRoomId = null;
        let roomUnsubscribe = null;
        let gameLoopId = null;
        let pendingAction = null; // 'create' or 'join'
        let selectedClassId = 'knight'; // Default
        
        // Game Data
        const CLASSES = [
            { id: 'knight', name: 'Knight', color: '#ef4444', desc: 'High Defense, Short Range' },
            { id: 'rogue', name: 'Rogue', color: '#10b981', desc: 'High Speed, Critical Hits' },
            { id: 'wizard', name: 'Wizard', color: '#3b82f6', desc: 'Low Health, Long Range' },
            { id: 'cleric', name: 'Cleric', color: '#f59e0b', desc: 'Healer, Party Buffs' }
        ];

        let localGrid = []; 
        let playersMap = {}; 
        const GRID_W = 15;
        const GRID_H = 15;

        // --- DOM ---
        const views = {
            loading: document.getElementById('view-loading'),
            menu: document.getElementById('view-menu'),
            charSelect: document.getElementById('view-character-select'),
            join: document.getElementById('view-join-input'),
            lobby: document.getElementById('view-lobby'),
            game: document.getElementById('view-game')
        };
        const els = {
            error: document.getElementById('error-display'),
            canvas: document.getElementById('game-canvas'),
            gameLoading: document.getElementById('game-loading'),
            charGrid: document.getElementById('char-grid'),
            charName: document.getElementById('char-desc-name'),
            charStats: document.getElementById('char-desc-stats')
        };
        const ctx = els.canvas.getContext('2d');

        // --- AUTH ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { showError(e.message); }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-display').textContent = `ID: ${user.uid.substr(0,4)}`;
                renderCharSelect(); // Prep the grid
                switchView('menu');
            }
        });

        // --- UI & NAVIGATION ---
        function switchView(name) {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[name].classList.remove('hidden');
            els.error.classList.add('hidden');
            if (name === 'game') resizeCanvas();
        }

        function showError(msg) {
            els.error.textContent = msg;
            els.error.classList.remove('hidden');
            setTimeout(() => els.error.classList.add('hidden'), 3000);
        }

        // --- CHARACTER SELECT ---
        function renderCharSelect() {
            els.charGrid.innerHTML = '';
            CLASSES.forEach(c => {
                const el = document.createElement('div');
                el.className = `char-card p-3 flex flex-col items-center bg-gray-900 ${c.id === selectedClassId ? 'selected' : ''}`;
                el.onclick = () => selectClass(c.id);
                
                el.innerHTML = `
                    <div class="w-8 h-8 mb-2 border-2 border-white" style="background-color: ${c.color}"></div>
                    <span class="text-[10px] text-gray-300 uppercase">${c.name}</span>
                `;
                els.charGrid.appendChild(el);
            });
            updateCharDesc();
        }

        function selectClass(id) {
            selectedClassId = id;
            renderCharSelect();
        }

        function updateCharDesc() {
            const c = CLASSES.find(x => x.id === selectedClassId);
            els.charName.textContent = c.name;
            els.charStats.textContent = c.desc;
        }

        function confirmCharacter() {
            // Save selection to currentUser object for easy access
            const c = CLASSES.find(x => x.id === selectedClassId);
            currentUser.gameColor = c.color;
            currentUser.gameName = c.name;
            currentUser.gameClassId = c.id;

            if (pendingAction === 'create') {
                createRoom();
            } else if (pendingAction === 'join') {
                switchView('join');
            }
        }

        // --- NETWORKING ---
        async function createRoom() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let code = "";
            for(let i=0; i<4; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'lobbies', code);
            await setDoc(roomRef, {
                hostId: currentUser.uid,
                status: 'waiting',
                players: [{ 
                    uid: currentUser.uid, 
                    name: currentUser.gameName, 
                    color: currentUser.gameColor,
                    classId: currentUser.gameClassId
                }]
            });
            currentRoomId = code;
            subscribeToRoom(code);
        }

        async function joinRoom(code) {
            code = code.toUpperCase();
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'lobbies', code);
            const snap = await getDoc(roomRef);
            if (!snap.exists()) return showError("Room not found");
            
            const data = snap.data();
            if (!data.players.some(p => p.uid === currentUser.uid)) {
                if (data.status !== 'waiting') return showError("Game in progress");
                await updateDoc(roomRef, {
                    players: arrayUnion({ 
                        uid: currentUser.uid, 
                        name: currentUser.gameName, 
                        color: currentUser.gameColor,
                        classId: currentUser.gameClassId
                    })
                });
            }
            currentRoomId = code;
            subscribeToRoom(code);
        }

        function subscribeToRoom(code) {
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'lobbies', code);
            roomUnsubscribe = onSnapshot(roomRef, (doc) => {
                if (!doc.exists()) { leaveRoom(); return; }
                const data = doc.data();
                
                // Lobby UI Update
                document.getElementById('display-room-code').textContent = code;
                const list = document.getElementById('player-list');
                list.innerHTML = '';
                data.players.forEach(p => {
                    const el = document.createElement('div');
                    el.className = "flex items-center gap-2 p-2 bg-gray-900 border border-gray-700";
                    el.innerHTML = `
                        <div class="w-4 h-4 border border-white" style="background:${p.color}"></div>
                        <div class="flex flex-col">
                            <span class="text-xs text-white">${p.name}</span>
                            <span class="text-[8px] text-gray-500">${p.uid.substr(0,4)}</span>
                        </div>
                    `;
                    list.appendChild(el);
                });

                // Host/Guest controls
                if (data.hostId === currentUser.uid) {
                    document.getElementById('host-controls').classList.remove('hidden');
                    document.getElementById('guest-controls').classList.add('hidden');
                } else {
                    document.getElementById('host-controls').classList.add('hidden');
                    document.getElementById('guest-controls').classList.remove('hidden');
                }

                if (data.status === 'playing') {
                    if (data.map) {
                        localGrid = JSON.parse(data.map);
                        playersMap = data.playerStates || {};
                        if (views.game.classList.contains('hidden')) enterGameMode();
                    } else {
                        views.game.classList.contains('hidden') ? switchView('game') : null;
                        els.gameLoading.classList.remove('hidden');
                    }
                }
            });
            switchView('lobby');
        }

        async function triggerStart() {
            // HOST LOGIC: Generate Map
            let map = [];
            for(let y=0; y<GRID_H; y++) {
                let row = [];
                for(let x=0; x<GRID_W; x++) {
                    if (y===0 || y===GRID_H-1 || x===0 || x===GRID_W-1) row.push(1);
                    else if (Math.random() < 0.1) row.push(1);
                    else row.push(0);
                }
                map.push(row);
            }

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'lobbies', currentRoomId);
            const snap = await getDoc(roomRef);
            const players = snap.data().players;
            
            let initialStates = {};
            players.forEach((p, index) => {
                initialStates[p.uid] = {
                    x: 2 + index,
                    y: 2,
                    color: p.color,
                    name: p.name,
                    classId: p.classId
                };
            });

            await updateDoc(roomRef, {
                status: 'playing',
                map: JSON.stringify(map),
                playerStates: initialStates
            });
        }

        function enterGameMode() {
            switchView('game');
            els.gameLoading.classList.add('hidden');
            resizeCanvas();
            if (!gameLoopId) loop();
        }

        // --- GAMEPLAY LOGIC ---
        function resizeCanvas() {
            const scale = 20; 
            els.canvas.width = GRID_W * scale;
            els.canvas.height = GRID_H * scale;
        }

        async function movePlayer(dx, dy) {
            if (!currentRoomId || !localGrid.length) return;
            const myState = playersMap[currentUser.uid];
            if (!myState) return;

            const targetX = myState.x + dx;
            const targetY = myState.y + dy;

            if (localGrid[targetY] && localGrid[targetY][targetX] === 1) return; // Hit wall

            myState.x = targetX;
            myState.y = targetY;
            
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'lobbies', currentRoomId);
            const updateField = `playerStates.${currentUser.uid}`;
            
            try {
                await updateDoc(roomRef, { [updateField]: myState });
            } catch (e) { console.error("Move sync failed", e); }
        }

        function draw() {
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, els.canvas.width, els.canvas.height);

            if (!localGrid.length) return;
            const tileW = els.canvas.width / GRID_W;
            const tileH = els.canvas.height / GRID_H;

            // Draw Map
            for(let y=0; y<GRID_H; y++) {
                for(let x=0; x<GRID_W; x++) {
                    if (localGrid[y][x] === 1) {
                        ctx.fillStyle = '#444'; 
                        ctx.fillRect(x*tileW, y*tileH, tileW, tileH);
                        ctx.fillStyle = '#555';
                        ctx.fillRect(x*tileW, y*tileH, tileW, 4);
                    } else {
                        ctx.fillStyle = '#222';
                        ctx.beginPath();
                        ctx.arc(x*tileW + tileW/2, y*tileH + tileH/2, 2, 0, Math.PI*2);
                        ctx.fill();
                    }
                }
            }

            // Draw Players
            Object.values(playersMap).forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x*tileW + 2, p.y*tileH + 2, tileW - 4, tileH - 4);
                
                ctx.fillStyle = 'white';
                ctx.fillRect(p.x*tileW + 5, p.y*tileH + 5, 4, 4);
                ctx.fillRect(p.x*tileW + 12, p.y*tileH + 5, 4, 4);
                
                // Tiny Class Icon on head (Simple shapes)
                ctx.fillStyle = 'white';
                if(p.classId === 'wizard') ctx.fillRect(p.x*tileW + tileW/2 - 2, p.y*tileH - 4, 4, 4); // Hat tip
                
                ctx.fillStyle = 'white';
                ctx.font = '8px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(p.name.substr(0,1), p.x*tileW + tileW/2, p.y*tileH + tileH - 4);
            });
        }

        function loop() {
            draw();
            gameLoopId = requestAnimationFrame(loop);
        }

        // --- EVENTS ---
        window.addEventListener('keydown', (e) => {
            if (views.game.classList.contains('hidden')) return;
            switch(e.key) {
                case 'ArrowUp': case 'w': movePlayer(0, -1); break;
                case 'ArrowDown': case 's': movePlayer(0, 1); break;
                case 'ArrowLeft': case 'a': movePlayer(-1, 0); break;
                case 'ArrowRight': case 'd': movePlayer(1, 0); break;
            }
        });

        const btnUp = document.getElementById('btn-up');
        const btnDown = document.getElementById('btn-down');
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');
        
        const addTouch = (el, dx, dy) => {
            el.addEventListener('touchstart', (e) => { e.preventDefault(); movePlayer(dx, dy); });
            el.addEventListener('mousedown', (e) => { e.preventDefault(); movePlayer(dx, dy); });
        };
        addTouch(btnUp, 0, -1);
        addTouch(btnDown, 0, 1);
        addTouch(btnLeft, -1, 0);
        addTouch(btnRight, 1, 0);

        // Buttons
        document.getElementById('btn-create-menu').onclick = () => {
            pendingAction = 'create';
            switchView('charSelect');
        };
        document.getElementById('btn-join-menu').onclick = () => {
            pendingAction = 'join';
            switchView('charSelect');
        };
        document.getElementById('btn-back-char').onclick = () => switchView('menu');
        document.getElementById('btn-confirm-char').onclick = confirmCharacter;
        
        document.getElementById('btn-back-join').onclick = () => switchView('menu');
        document.getElementById('btn-confirm-join').onclick = () => joinRoom(document.getElementById('input-room-code').value);
        document.getElementById('btn-start-game').onclick = triggerStart;
        document.getElementById('btn-leave-lobby').onclick = leaveRoom;
        document.getElementById('btn-exit-game').onclick = leaveRoom;

        document.getElementById('display-room-code').onclick = () => {
             const r = document.createRange(); r.selectNode(document.getElementById('display-room-code'));
             window.getSelection().removeAllRanges(); window.getSelection().addRange(r);
             document.execCommand('copy');
             alert("Copied!");
        };

        function leaveRoom() {
            if (roomUnsubscribe) roomUnsubscribe();
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
            currentRoomId = null;
            localGrid = [];
            switchView('menu');
        }

        initAuth();

    </script>
</body>
</html>
